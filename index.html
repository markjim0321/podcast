<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Podcast 播放</title>
  <meta name="color-scheme" content="light">
  <link rel="preconnect" href="https://storage.googleapis.com" crossorigin>

  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --card:#ffffff; --bg:#f8fafc;
      --accent:#0f766e; --accent-press:#0b5f59; --badge-bg:#eef2ff;
      --shadow:0 1px 2px rgba(0,0,0,.06), 0 4px 12px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --fg:#e5e7eb; --muted:#94a3b8; --line:#334155; --card:#0b1220; --bg:#050816;
        --badge-bg:#0b1220; --shadow:none; --accent:#22c55e; --accent-press:#16a34a;
      }
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:var(--card);
      border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(6px)}
    .bar{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .t{font-size:18px;font-weight:800;letter-spacing:.3px;margin-right:auto}
    .controls{display:flex;gap:8px;flex:1}
    .select{flex:1;min-width:0;appearance:none;background:#fff;color:var(--fg);
      border:1px solid var(--line);border-radius:12px;padding:12px 40px 12px 12px;font-size:15px}
    select.select{
      background-image:url("data:image/svg+xml;utf8,<svg fill='%23111' height='14' viewBox='0 0 24 24' width='14' xmlns='http://www.w3.org/2000/svg'><path d=\"M7 10l5 5 5-5\"/></svg>");
      background-repeat:no-repeat;background-position:right 12px center;background-size:14px 14px
    }
    select.select::-ms-expand{display:none}

    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    @media (min-width:720px){ .controls{max-width:560px} .grid{grid-template-columns:repeat(2,1fr)} }

    .card{border:1px solid var(--line);border-radius:16px;background:var(--card);
      padding:14px;box-shadow:var(--shadow);transition:transform .08s ease}
    .card:active{transform:scale(.996)}

    .title{font-weight:800;line-height:1.35;font-size:16px}
    .sub{margin-top:6px;font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;
      background:var(--badge-bg);border:1px solid var(--line);
      font-size:11px;padding:4px 8px;border-radius:999px;font-weight:700}

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:12px}
    .btn{border:0;border-radius:12px;background:var(--accent);color:#fff;
      padding:12px 16px;font-size:14px;font-weight:700;letter-spacing:.3px}
    .btn:active{background:var(--accent-press)}

    .empty{color:var(--muted);text-align:center;padding:28px 0}

    footer.player{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--line)}
    .player-inner{max-width:980px;margin:0 auto;padding:10px 16px}
    #now{font-size:14px;margin:4px 0 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    audio{width:100%}

    /* skeleton */
    .skel{border:1px solid var(--line);border-radius:16px;background:var(--card);padding:14px}
    .sbar{height:14px;background:linear-gradient(90deg,#e5e7eb,#f3f4f6,#e5e7eb);
      background-size:200% 100%;animation:shimmer 1.4s infinite; border-radius:8px}
    .sbar+.sbar{margin-top:10px;height:10px;width:60%}
    @keyframes shimmer{0%{background-position:0 0}100%{background-position:-200% 0}}
    
    html, body, select, option, optgroup, input, button {
    color-scheme: light;
    }

  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="t">Podcast 播放</div>
      <div class="controls">
        <select id="subject" class="select" title="選擇科目">
          <option value="">全部科目</option>
        </select>
        <select id="volume" class="select" title="選擇冊次">
          <option value="">全部冊次</option>
        </select>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">沒有資料</div>
  </main>

  <footer class="player">
    <div class="player-inner">
      <div id="now">尚未播放</div>
      <audio id="player" controls preload="metadata"></audio>
    </div>
  </footer>

  <script>
    const subjectSel = document.getElementById('subject');
    const volumeSel  = document.getElementById('volume');
    const listEl     = document.getElementById('list');
    const emptyEl    = document.getElementById('empty');
    const player     = document.getElementById('player');
    const now        = document.getElementById('now');

    let data = [];
    let subjects = new Set();
    let volumes  = new Set();

    const subjectOrder = ["國文","英文","數學","自然","公民","地理","歷史"];
    const subjectColor = {
      "國文":"#dc2626",
      "英文":"#1d4ed8",
      "數學":"#7c3aed",
      "自然":"#0f766e",
      "公民":"#2563eb",
      "地理":"#0ea5e9",
      "歷史":"#b45309"
    };

    const volumeRe = /^(?:第)?[一二三四五六七八九十百0-9]+冊$/;
    const chineseNums = { 一:1, 二:2, 三:3, 四:4, 五:5, 六:6, 七:7, 八:8, 九:9, 十:10 };
    function parseVolume(v){
      if(!v) return 0;
      const m = v.match(/第?([一二三四五六七八九十0-9]+)冊/);
      if(!m) return 0;
      const txt = m[1];
      if(/^\d+$/.test(txt)) return parseInt(txt,10);
      return chineseNums[txt] || 0;
    }
    function extractVolume(url){
      try{
        const u = new URL(url);
        const parts = decodeURI(u.pathname).split('/').filter(Boolean);
        const idx = parts.indexOf('audio');
        if (idx >= 0){
          const candidates = parts.slice(idx+1, idx+5)
            .filter(seg => !/\.[a-z0-9]+$/i.test(seg));
          const exact = candidates.find(seg => volumeRe.test(seg));
          if (exact) return exact;
          const looser = candidates.join(' ').match(/(?:第)?[一二三四五六七八九十百0-9]+冊/);
          if (looser) return looser[0];
        }
        const name = parts[parts.length-1] || '';
        const m = decodeURI(name).match(/(?:第)?[一二三四五六七八九十百0-9]+冊/);
        return m ? m[0] : '';
      }catch{ return ''; }
    }

    function showSkeleton(){
      listEl.innerHTML = '';
      for(let i=0;i<4;i++){
        const c = document.createElement('div');
        c.className = 'skel';
        c.innerHTML = '<div class="sbar" style="width:80%"></div><div class="sbar"></div>';
        listEl.appendChild(c);
      }
    }

    function indexFilters(items){
      subjects.clear(); volumes.clear();
      for (const it of items){
        if (it.subject) subjects.add(it.subject);
        const vol = extractVolume(it.url);
        it._volume = vol || '';
        if (vol && volumeRe.test(vol)) volumes.add(vol);
      }
    }

    function renderFilterOptions(){
      subjectSel.length = 1; 
      volumeSel.length  = 1; 
      const sortedSubjects = Array.from(subjects).sort((a, b) => {
        const ai = subjectOrder.indexOf(a);
        const bi = subjectOrder.indexOf(b);
        if (ai === -1 && bi === -1) return a.localeCompare(b, "zh-Hant");
        if (ai === -1) return 1;
        if (bi === -1) return -1;
        return ai - bi;
      });
      for(const s of sortedSubjects){
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        subjectSel.appendChild(opt);
      }
      for(const v of Array.from(volumes).sort((a,b)=>parseVolume(a)-parseVolume(b))){
        const opt = document.createElement('option');
        opt.value = opt.textContent = v;
        volumeSel.appendChild(opt);
      }
    }

    function renderList(){
      const subj = subjectSel.value;
      const vol  = volumeSel.value;
      const rows = data.filter(it =>
        (!subj || it.subject === subj) &&
        (!vol  || it._volume === vol)
      );
      listEl.innerHTML = '';
      if(!rows.length) return showEmpty('沒有符合條件的檔案');
      emptyEl.style.display = 'none';
      rows.sort((a,b) => (b.date||'').localeCompare(a.date||''));
      for(const it of rows){
        const card  = document.createElement('div'); card.className = 'card';
        const title = document.createElement('div'); title.className = 'title';
        title.textContent = it.title || '(未命名)';
        const sub   = document.createElement('div'); sub.className = 'sub';
        if (it.subject){
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = it.subject;
          const c = subjectColor[it.subject];
          if (c){ badge.style.color=c; badge.style.borderColor=c+"20"; }
          sub.appendChild(badge);
        }
        const meta = [];
        if(it._volume)  meta.push(it._volume);
        if(it.date)     meta.push(it.date);
        if(it.duration) meta.push(it.duration);
        if (meta.length){
          const span = document.createElement('span');
          span.textContent = meta.join(' ｜ ');
          sub.appendChild(span);
        }
        const row   = document.createElement('div'); row.className = 'row';
        const btn   = document.createElement('button'); btn.className = 'btn';
        btn.textContent = '播放';
        btn.onclick = () => play(it);
        row.appendChild(btn);
        card.appendChild(title);
        card.appendChild(sub);
        card.appendChild(row);
        listEl.appendChild(card);
      }
    }

    function showEmpty(msg){
      listEl.innerHTML = '';
      emptyEl.style.display = '';
      emptyEl.textContent = msg || '沒有資料';
    }

    function play(item){
      player.src = item.url;
      player.play().catch(e => console.error('play() 失敗：', e));
      now.textContent = `🎵 正在播放：${item.title || '(未命名)'}`;
      player.onloadedmetadata = () => {
        if(!item.duration && player.duration && isFinite(player.duration)){
          const s  = Math.round(player.duration);
          const mm = String(Math.floor(s/60)).padStart(2,'0');
          const ss = String(s%60).padStart(2,'0');
          now.textContent = `🎵 正在播放：${item.title || '(未命名)'}（${mm}:${ss}）`;
        }
      };
    }

    subjectSel.addEventListener('change', renderList);
    volumeSel.addEventListener('change', renderList);

    showSkeleton();
    fetch('./podcasts.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(items => {
        data = Array.isArray(items) ? items : [];
        indexFilters(data);
        renderFilterOptions();
        renderList();
      })
      .catch(err => {
        console.error('讀取 podcasts.json 失敗：', err);
        showEmpty('清單載入失敗');
      });
  </script>
</body>
</html>
