<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Podcast æ’­æ”¾</title>
  <meta name="color-scheme" content="light">
  <style>
    /* â€”â€” åŸºæœ¬æ¨£å¼ï¼ˆç™½åº•è¡Œå‹•å„ªå…ˆï¼‰ â€”â€” */
    :root{--fg:#111;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--accent:#111}
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .bar{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .t{font-size:18px;font-weight:700;margin-right:auto}
    .controls{display:flex;gap:8px;flex:1}
    .select{flex:1;min-width:0;appearance:none;background:#fff;color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px 36px 10px 12px;font-size:14px;position:relative}
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    .grid{display:grid;gap:10px}
    .card{border:1px solid var(--line);border-radius:14px;background:var(--card);padding:12px}
    .title{font-weight:700;line-height:1.35}
    .sub{margin-top:4px;font-size:12px;color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .btn{border:0;border-radius:10px;background:var(--accent);color:#fff;padding:10px 14px;font-size:14px}
    .empty{color:var(--muted);text-align:center;padding:28px 0}
    footer.player{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line)}
    .player-inner{max-width:980px;margin:0 auto;padding:8px 16px}
    #now{font-size:14px;margin:4px 0 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    audio{width:100%}
    /* å°è¢å¹•å„ªåŒ– */
    @media (min-width:720px){
      .controls{max-width:560px}
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    /* è‡ªè¨‚ä¸‹æ‹‰ç®­é ­ï¼ˆå³å´å°ä¸‰è§’ï¼‰ */
    select.select{
      background-image:url("data:image/svg+xml;utf8,<svg fill='%23111' height='14' viewBox='0 0 24 24' width='14' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5'/></svg>");
      background-repeat:no-repeat;
      background-position:right 12px center;
      background-size:14px 14px;
    }
    select.select::-ms-expand{display:none}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="t">Podcast æ’­æ”¾</div>
      <div class="controls">
        <select id="subject" class="select" title="é¸æ“‡ç§‘ç›®">
          <option value="">å…¨éƒ¨ç§‘ç›®</option>
        </select>
        <select id="volume" class="select" title="é¸æ“‡å†Šæ¬¡">
          <option value="">å…¨éƒ¨å†Šæ¬¡</option>
        </select>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">è¼‰å…¥ä¸­â€¦</div>
  </main>

  <footer class="player">
    <div class="player-inner">
      <div id="now">å°šæœªæ’­æ”¾</div>
      <audio id="player" controls preload="metadata"></audio>
    </div>
  </footer>

  <script>
    // å–å…ƒç´ 
    const subjectSel = document.getElementById('subject');
    const volumeSel  = document.getElementById('volume');
    const listEl     = document.getElementById('list');
    const emptyEl    = document.getElementById('empty');
    const player     = document.getElementById('player');
    const now        = document.getElementById('now');

    let data = [];           // å…¨éƒ¨æ¸…å–®
    let subjects = new Set();// ç§‘ç›®é›†åˆ
    let volumes  = new Set();// å†Šæ¬¡é›†åˆï¼ˆå¾ URL è§£æï¼‰

    // è®€ podcasts.jsonï¼ˆå’Œ index.html åŒå±¤ï¼‰
    fetch('./podcasts.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(items => {
        data = Array.isArray(items) ? items : [];
        indexFilters(data);
        renderFilterOptions();
        renderList();
      })
      .catch(err => {
        console.error('è®€å– podcasts.json å¤±æ•—ï¼š', err);
        showEmpty('æ¸…å–®è¼‰å…¥å¤±æ•—');
      });

    // å»ºç«‹ç¯©é¸ï¼ˆç§‘ç›®ã€å†Šæ¬¡ï¼‰
    function indexFilters(items){
      subjects.clear(); volumes.clear();
      for(const it of items){
        // ç§‘ç›®ï¼šè‹¥ json æ²’çµ¦ subjectï¼Œå¯å˜—è©¦å¾ URL è£œæŠ“
        const subj = it.subject || extractSubject(it.url) || '';
        it._subject = subj;
        if(subj) subjects.add(subj);

        const vol = extractVolume(it.url);
        it._volume = vol || '';
        if(vol) volumes.add(vol);
      }
    }

    // å¾ URL è§£æã€Œå†Šæ¬¡ã€ï¼šåœ¨ "audio" ä¹‹å¾Œçš„å¹¾å€‹æ®µè½ä¸­æ‰¾åŒ…å«ã€Œå†Šã€çš„å­—ä¸²
    function extractVolume(url){
      try{
        const u = new URL(url);
        const parts = decodeURI(u.pathname).split('/').filter(Boolean);
        // å…¸å‹è·¯å¾‘ï¼š
        // /shuim-w-knsh/audio/å…¬æ°‘/ç¬¬ä¸€å†Š/æª”å.wav
        // /shuim-w-knsh/audio/ç¬¬äºŒå†Š/æª”å.wav
        const idx = parts.indexOf('audio');
        if (idx >= 0) {
          const candidates = parts.slice(idx + 1, idx + 4); // audio å¾Œ 1~3 æ®µ
          const vol = candidates.find(seg => /å†Š/.test(seg));
          if (vol) return vol;
        }
        // å‚™æ´ï¼šå¾æª”åæŠ“ï¼ˆå¦‚ã€Œå…¬æ°‘ ç¬¬ä¸‰å†Š ç¬¬1èª².wavã€ï¼‰
        const name = parts[parts.length - 1] || '';
        const m = name.match(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾0-9]+å†Š)/);
        return m ? m[1] : '';
      } catch { return ''; }
    }

    // å¾ URL è§£æã€Œç§‘ç›®ã€ï¼ˆè‹¥ JSON æœªæä¾›ï¼‰ï¼šå– audio ä¹‹å¾Œç¬¬ä¸€å€‹ä¸”ä¸å«ã€Œå†Šã€çš„æ®µ
    function extractSubject(url){
      try{
        const u = new URL(url);
        const parts = decodeURI(u.pathname).split('/').filter(Boolean);
        const idx = parts.indexOf('audio');
        if (idx >= 0) {
          const a = parts[idx + 1] || '';
          if (a && !/å†Š/.test(a) && !/\.[a-z0-9]+$/i.test(a)) return a; // éæª”åä¸”ä¸å«ã€Œå†Šã€
        }
        return '';
      } catch { return ''; }
    }

    // å¡«å…¥ä¸‹æ‹‰é¸é …
    function renderFilterOptions(){
      // æ¸…ç©ºèˆŠé¸é …ï¼ˆä¿ç•™ã€Œå…¨éƒ¨ã€ï¼‰
      subjectSel.length = 1;
      volumeSel.length = 1;

      // ç§‘ç›®
      for(const s of Array.from(subjects).sort()){
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        subjectSel.appendChild(opt);
      }
      // å†Šæ¬¡
      for(const v of Array.from(volumes).sort()){
        const opt = document.createElement('option');
        opt.value = opt.textContent = v;
        volumeSel.appendChild(opt);
      }
    }

    // ç¯©é¸ + æ¸²æŸ“æ¸…å–®
    function renderList(){
      const subj = subjectSel.value;
      const vol  = volumeSel.value;

      const rows = data.filter(it =>
        (!subj || it._subject === subj) &&
        (!vol  || it._volume  === vol)
      );

      listEl.innerHTML = '';
      if(!rows.length) return showEmpty('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æª”æ¡ˆ');

      emptyEl.style.display = 'none';

      // ä¾æ—¥æœŸæ–°åˆ°èˆŠï¼ˆè‹¥æ²’æœ‰ date æ¬„ä½å‰‡ä¸å½±éŸ¿é †åºï¼‰
      rows.sort((a,b) => (b.date||'').localeCompare(a.date||''));

      for(const it of rows){
        const card  = document.createElement('div');
        card.className = 'card';

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = it.title || '(æœªå‘½å)';

        const sub   = document.createElement('div');
        sub.className = 'sub';
        const parts = [];
        if(it._subject) parts.push(it._subject);
        if(it._volume)  parts.push(it._volume);
        if(it.date)     parts.push(it.date);
        if(it.duration) parts.push(it.duration);
        sub.textContent = parts.join(' ï½œ ');

        const row   = document.createElement('div');
        row.className = 'row';

        const btn   = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'æ’­æ”¾';
        btn.onclick = () => play(it);

        row.appendChild(btn);

        card.appendChild(title);
        card.appendChild(sub);
        card.appendChild(row);
        listEl.appendChild(card);
      }
    }

    function showEmpty(msg){
      listEl.innerHTML = '';
      emptyEl.style.display = '';
      emptyEl.textContent = msg || 'æ²’æœ‰è³‡æ–™';
    }

    function play(item){
      // ç›´æ¥ä½¿ç”¨ JSON è£¡çš„åŸå§‹ URLï¼ˆä¸å† encodeï¼‰
      player.src = item.url;
      player.play().catch(e => console.error('play() å¤±æ•—ï¼š', e));
      now.textContent = `ğŸµ æ­£åœ¨æ’­æ”¾ï¼š${item.title || '(æœªå‘½å)'}`;

      // è‹¥æœªæä¾›æ™‚é•·ï¼Œè¼‰å…¥å¾Œé¡¯ç¤º
      player.onloadedmetadata = () => {
        if(!item.duration && player.duration && isFinite(player.duration)){
          const s = Math.round(player.duration);
          const mm = String(Math.floor(s/60)).padStart(2,'0');
          const ss = String(s%60).padStart(2,'0');
          now.textContent = `ğŸµ æ­£åœ¨æ’­æ”¾ï¼š${item.title || '(æœªå‘½å)'}ï¼ˆ${mm}:${ss}ï¼‰`;
        }
      };
    }

    // ç›£è½ä¸‹æ‹‰è®Šæ›´
    subjectSel.addEventListener('change', renderList);
    volumeSel.addEventListener('change', renderList);
  </script>
</body>
</html>
