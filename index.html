<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Podcast æ’­æ”¾</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{--fg:#111;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--accent:#111}
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .bar{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .t{font-size:18px;font-weight:700;margin-right:auto}
    .controls{display:flex;gap:8px;flex:1}
    .select{flex:1;min-width:0;appearance:none;background:#fff;color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px}
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    .grid{display:grid;gap:10px}
    .card{border:1px solid var(--line);border-radius:14px;background:var(--card);padding:12px}
    .title{font-weight:700;line-height:1.35}
    .sub{margin-top:4px;font-size:12px;color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .btn{border:0;border-radius:10px;background:var(--accent);color:#fff;padding:10px 14px;font-size:14px}
    .empty{color:var(--muted);text-align:center;padding:28px 0}
    footer.player{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line)}
    .player-inner{max-width:980px;margin:0 auto;padding:8px 16px}
    #now{font-size:14px;margin:4px 0 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    audio{width:100%}
    @media (min-width:720px){
      .controls{max-width:560px}
      .grid{grid-template-columns:repeat(2,1fr)}
    }

    /* ä¸‹æ‹‰ç®­é ­æ¨£å¼ */
    select.select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 8px 30px 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      background-image: url("data:image/svg+xml;utf8,<svg fill='%23333' height='12' viewBox='0 0 24 24' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 12px 12px;
    }
    select.select::-ms-expand {display: none;}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="t">Podcast æ’­æ”¾</div>
      <div class="controls">
        <select id="subject" class="select" title="é¸æ“‡ç§‘ç›®">
          <option value="">å…¨éƒ¨ç§‘ç›®</option>
        </select>
        <select id="volume" class="select" title="é¸æ“‡å†Šæ¬¡">
          <option value="">å…¨éƒ¨å†Šæ¬¡</option>
        </select>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">æ²’æœ‰è³‡æ–™</div>
  </main>

  <footer class="player">
    <div class="player-inner">
      <div id="now">å°šæœªæ’­æ”¾</div>
      <audio id="player" controls preload="metadata"></audio>
    </div>
  </footer>

  <script>
    const subjectSel = document.getElementById('subject');
    const volumeSel  = document.getElementById('volume');
    const listEl     = document.getElementById('list');
    const emptyEl    = document.getElementById('empty');
    const player     = document.getElementById('player');
    const now        = document.getElementById('now');

    let data = [];
    let subjects = new Set();
    let volumes  = new Set();

    // å†Šæ¬¡æ­£å‰‡
    const volumeRe = /^(?:ç¬¬)?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾0-9]+å†Š$/;

    // è¼‰å…¥ podcasts.json
    fetch('./podcasts.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(items => {
        data = Array.isArray(items) ? items : [];
        indexFilters(data);
        renderFilterOptions();
        renderList();
      })
      .catch(err => {
        console.error('è®€å– podcasts.json å¤±æ•—ï¼š', err);
        showEmpty('æ¸…å–®è¼‰å…¥å¤±æ•—');
      });

    function indexFilters(items){
      subjects.clear(); volumes.clear();
      for (const it of items){
        if (it.subject) subjects.add(it.subject);

        const vol = extractVolume(it.url);
        it._volume = vol || '';
        if (vol && volumeRe.test(vol)) {
          volumes.add(vol);
        }
      }
    }

    function extractVolume(url){
      try{
        const u = new URL(url);
        const parts = decodeURI(u.pathname).split('/').filter(Boolean);
        const idx = parts.indexOf('audio');
        if (idx >= 0){
          const candidates = parts.slice(idx+1, idx+5)
            .filter(seg => !/\.[a-z0-9]+$/i.test(seg));
          const exact = candidates.find(seg => volumeRe.test(seg));
          if (exact) return exact;
          const looser = candidates.join(' ').match(/(?:ç¬¬)?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾0-9]+å†Š/);
          if (looser) return looser[0];
        }
        const name = parts[parts.length-1] || '';
        const m = decodeURI(name).match(/(?:ç¬¬)?[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾0-9]+å†Š/);
        return m ? m[0] : '';
      }catch{ return ''; }
    }

    function renderFilterOptions(){
      for(const s of Array.from(subjects).sort()){
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        subjectSel.appendChild(opt);
      }
              // ä¸­æ–‡æ•¸å­—å°ç…§è¡¨
        const chineseNums = { ä¸€:1, äºŒ:2, ä¸‰:3, å››:4, äº”:5, å…­:6, ä¸ƒ:7, å…«:8, ä¹:9, å:10 };

        // æŠŠã€Œç¬¬ä¸€å†Šã€è½‰æ•¸å­—
        function parseVolume(v){
          if(!v) return 0;
          const m = v.match(/ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å0-9]+)å†Š/);
          if(!m) return 0;
          const txt = m[1];

          // å¦‚æœæ˜¯é˜¿æ‹‰ä¼¯æ•¸å­—
          if(/^\d+$/.test(txt)) return parseInt(txt,10);

          // ç°¡å–®è™•ç† 1-10
          return chineseNums[txt] || 0;
        }

        // å†Šæ¬¡æ’åº
        for(const v of Array.from(volumes).sort((a,b)=>parseVolume(a)-parseVolume(b))){
          const opt = document.createElement('option');
          opt.value = opt.textContent = v;
          volumeSel.appendChild(opt);
        }
    }

    function renderList(){
      const subj = subjectSel.value;
      const vol  = volumeSel.value;
      const rows = data.filter(it =>
        (!subj || it.subject === subj) &&
        (!vol  || it._volume === vol)
      );
      listEl.innerHTML = '';
      if(!rows.length) return showEmpty('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æª”æ¡ˆ');
      emptyEl.style.display = 'none';
      rows.sort((a,b) => (b.date||'').localeCompare(a.date||''));
      for(const it of rows){
        const card  = document.createElement('div');
        card.className = 'card';
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = it.title || '(æœªå‘½å)';
        const sub   = document.createElement('div');
        sub.className = 'sub';
        const parts = [];
        if(it.subject) parts.push(it.subject);
        if(it._volume) parts.push(it._volume);
        if(it.date)    parts.push(it.date);
        if(it.duration)parts.push(it.duration);
        sub.textContent = parts.join(' ï½œ ');
        const row   = document.createElement('div');
        row.className = 'row';
        const btn   = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'æ’­æ”¾';
        btn.onclick = () => play(it);
        row.appendChild(btn);
        card.appendChild(title);
        card.appendChild(sub);
        card.appendChild(row);
        listEl.appendChild(card);
      }
    }

    function showEmpty(msg){
      listEl.innerHTML = '';
      emptyEl.style.display = '';
      emptyEl.textContent = msg || 'æ²’æœ‰è³‡æ–™';
    }

    function play(item){
      player.src = item.url;
      player.play().catch(e => console.error('play() å¤±æ•—ï¼š', e));
      now.textContent = `ğŸµ æ­£åœ¨æ’­æ”¾ï¼š${item.title || '(æœªå‘½å)'}`;
      player.onloadedmetadata = () => {
        if(!item.duration && player.duration && isFinite(player.duration)){
          const s = Math.round(player.duration);
          const mm = String(Math.floor(s/60)).padStart(2,'0');
          const ss = String(s%60).padStart(2,'0');
          now.textContent = `ğŸµ æ­£åœ¨æ’­æ”¾ï¼š${item.title || '(æœªå‘½å)'}ï¼ˆ${mm}:${ss}ï¼‰`;
        }
      };
    }

    subjectSel.addEventListener('change', renderList);
    volumeSel.addEventListener('change', renderList);
  </script>
</body>
</html>
