<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Podcast 播放</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{--fg:#111;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--accent:#111}
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .bar{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .t{font-size:18px;font-weight:700;margin-right:auto}
    .controls{display:flex;gap:8px;flex:1}
    .select{flex:1;min-width:0;appearance:none;background:#fff;color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px}
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    .grid{display:grid;gap:10px}
    .card{border:1px solid var(--line);border-radius:14px;background:var(--card);padding:12px}
    .title{font-weight:700;line-height:1.35}
    .sub{margin-top:4px;font-size:12px;color:var(--muted)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .btn{border:0;border-radius:10px;background:var(--accent);color:#fff;padding:10px 14px;font-size:14px}
    .empty{color:var(--muted);text-align:center;padding:28px 0}
    footer.player{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line)}
    .player-inner{max-width:980px;margin:0 auto;padding:8px 16px}
    #now{font-size:14px;margin:4px 0 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    audio{width:100%}
    @media (min-width:720px){
      .controls{max-width:560px}
      .grid{grid-template-columns:repeat(2,1fr)}
    }

    /* 下拉箭頭樣式 */
    select.select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 8px 30px 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      background-image: url("data:image/svg+xml;utf8,<svg fill='%23333' height='12' viewBox='0 0 24 24' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 12px 12px;
    }
    select.select::-ms-expand {display: none;}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="t">Podcast 播放</div>
      <div class="controls">
        <select id="subject" class="select" title="選擇科目">
          <option value="">全部科目</option>
        </select>
        <select id="volume" class="select" title="選擇冊次">
          <option value="">全部冊次</option>
        </select>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">沒有資料</div>
  </main>

  <footer class="player">
    <div class="player-inner">
      <div id="now">尚未播放</div>
      <audio id="player" controls preload="metadata"></audio>
    </div>
  </footer>

  <script>
    const subjectSel = document.getElementById('subject');
    const volumeSel  = document.getElementById('volume');
    const listEl     = document.getElementById('list');
    const emptyEl    = document.getElementById('empty');
    const player     = document.getElementById('player');
    const now        = document.getElementById('now');

    let data = [];
    let subjects = new Set();
    let volumes  = new Set();

    // 冊次正則
    const volumeRe = /^(?:第)?[一二三四五六七八九十百0-9]+冊$/;

    // 載入 podcasts.json
    fetch('./podcasts.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(items => {
        data = Array.isArray(items) ? items : [];
        indexFilters(data);
        renderFilterOptions();
        renderList();
      })
      .catch(err => {
        console.error('讀取 podcasts.json 失敗：', err);
        showEmpty('清單載入失敗');
      });

    function indexFilters(items){
      subjects.clear(); volumes.clear();
      for (const it of items){
        if (it.subject) subjects.add(it.subject);

        const vol = extractVolume(it.url);
        it._volume = vol || '';
        if (vol && volumeRe.test(vol)) {
          volumes.add(vol);
        }
      }
    }

    function extractVolume(url){
      try{
        const u = new URL(url);
        const parts = decodeURI(u.pathname).split('/').filter(Boolean);
        const idx = parts.indexOf('audio');
        if (idx >= 0){
          const candidates = parts.slice(idx+1, idx+5)
            .filter(seg => !/\.[a-z0-9]+$/i.test(seg));
          const exact = candidates.find(seg => volumeRe.test(seg));
          if (exact) return exact;
          const looser = candidates.join(' ').match(/(?:第)?[一二三四五六七八九十百0-9]+冊/);
          if (looser) return looser[0];
        }
        const name = parts[parts.length-1] || '';
        const m = decodeURI(name).match(/(?:第)?[一二三四五六七八九十百0-9]+冊/);
        return m ? m[0] : '';
      }catch{ return ''; }
    }

    function renderFilterOptions(){
      for(const s of Array.from(subjects).sort()){
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        subjectSel.appendChild(opt);
      }
              // 中文數字對照表
        const chineseNums = { 一:1, 二:2, 三:3, 四:4, 五:5, 六:6, 七:7, 八:8, 九:9, 十:10 };

        // 把「第一冊」轉數字
        function parseVolume(v){
          if(!v) return 0;
          const m = v.match(/第([一二三四五六七八九十0-9]+)冊/);
          if(!m) return 0;
          const txt = m[1];

          // 如果是阿拉伯數字
          if(/^\d+$/.test(txt)) return parseInt(txt,10);

          // 簡單處理 1-10
          return chineseNums[txt] || 0;
        }

        // 冊次排序
        for(const v of Array.from(volumes).sort((a,b)=>parseVolume(a)-parseVolume(b))){
          const opt = document.createElement('option');
          opt.value = opt.textContent = v;
          volumeSel.appendChild(opt);
        }
    }

    function renderList(){
      const subj = subjectSel.value;
      const vol  = volumeSel.value;
      const rows = data.filter(it =>
        (!subj || it.subject === subj) &&
        (!vol  || it._volume === vol)
      );
      listEl.innerHTML = '';
      if(!rows.length) return showEmpty('沒有符合條件的檔案');
      emptyEl.style.display = 'none';
      rows.sort((a,b) => (b.date||'').localeCompare(a.date||''));
      for(const it of rows){
        const card  = document.createElement('div');
        card.className = 'card';
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = it.title || '(未命名)';
        const sub   = document.createElement('div');
        sub.className = 'sub';
        const parts = [];
        if(it.subject) parts.push(it.subject);
        if(it._volume) parts.push(it._volume);
        if(it.date)    parts.push(it.date);
        if(it.duration)parts.push(it.duration);
        sub.textContent = parts.join(' ｜ ');
        const row   = document.createElement('div');
        row.className = 'row';
        const btn   = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = '播放';
        btn.onclick = () => play(it);
        row.appendChild(btn);
        card.appendChild(title);
        card.appendChild(sub);
        card.appendChild(row);
        listEl.appendChild(card);
      }
    }

    function showEmpty(msg){
      listEl.innerHTML = '';
      emptyEl.style.display = '';
      emptyEl.textContent = msg || '沒有資料';
    }

    function play(item){
      player.src = item.url;
      player.play().catch(e => console.error('play() 失敗：', e));
      now.textContent = `🎵 正在播放：${item.title || '(未命名)'}`;
      player.onloadedmetadata = () => {
        if(!item.duration && player.duration && isFinite(player.duration)){
          const s = Math.round(player.duration);
          const mm = String(Math.floor(s/60)).padStart(2,'0');
          const ss = String(s%60).padStart(2,'0');
          now.textContent = `🎵 正在播放：${item.title || '(未命名)'}（${mm}:${ss}）`;
        }
      };
    }

    subjectSel.addEventListener('change', renderList);
    volumeSel.addEventListener('change', renderList);
  </script>
</body>
</html>
